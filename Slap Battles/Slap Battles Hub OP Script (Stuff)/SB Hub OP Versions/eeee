-- Orion Hub Configuration System (No UI Version) - FIXED
-- Created by [Your Name]

-- Services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")

-- Variables
local player = Players.LocalPlayer
local configsFolder = "OrionHub_Configs"
local currentConfig = nil
local autoLoadEnabled = false
local configsList = {}

-- Store all script settings here
local ScriptSettings = {}

-- Create configs folder if it doesn't exist
if not isfolder(configsFolder) then
    makefolder(configsFolder)
end

-- Function to refresh configs list
local function refreshConfigsList()
    configsList = {}
    local success, files = pcall(listfiles, configsFolder)
    
    if success and files then
        for _, file in pairs(files) do
            local configName = string.match(file, configsFolder .. "\\(.+)%.json")
            if configName then
                table.insert(configsList, configName)
            end
        end
    end
    table.sort(configsList)
    return configsList
end

-- Function to register a setting (call this when you create toggles/sliders)
local function registerSetting(name, valueObject, settingType)
    ScriptSettings[name] = {
        Object = valueObject,
        Type = settingType or "Toggle" -- Can be "Toggle", "Slider", "Dropdown", "TextBox"
    }
end

-- Function to get setting value
local function getSettingValue(name)
    if ScriptSettings[name] then
        local obj = ScriptSettings[name].Object
        if obj and obj.Value ~= nil then
            return obj.Value
        elseif obj and obj.Get ~= nil then
            return obj:Get()
        end
    end
    return nil
end

-- Function to set setting value
local function setSettingValue(name, value)
    if ScriptSettings[name] then
        local obj = ScriptSettings[name].Object
        if obj and obj.Set ~= nil then
            obj:Set(value)
            return true
        elseif obj and obj.Value ~= nil then
            obj.Value = value
            return true
        end
    end
    return false
end

-- Function to save configuration
local function saveConfig(configName, overwrite)
    if not configName or configName == "" then
        warn("[Config] Error: Please enter a config name!")
        return false
    end
    
    -- Check if config already exists
    local filePath = configsFolder .. "/" .. configName .. ".json"
    local configExists = isfile(filePath)
    
    if configExists and not overwrite then
        warn("[Config] Error: Config '" .. configName .. "' already exists! Use overwrite.")
        return false
    end
    
    -- Gather all current settings
    local configData = {
        Version = "1.0",
        SavedAt = os.date("%Y-%m-%d %H:%M:%S"),
        GameId = game.GameId,
        PlayerName = player.Name,
        Settings = {}
    }
    
    -- Save all registered settings
    for name, setting in pairs(ScriptSettings) do
        local value = getSettingValue(name)
        if value ~= nil then
            configData.Settings[name] = {
                Value = value,
                Type = setting.Type
            }
        end
    end
    
    -- Convert to JSON
    local jsonData
    local success, err = pcall(function()
        jsonData = HttpService:JSONEncode(configData)
    end)
    
    if not success then
        warn("[Config] Error: Failed to encode config data: " .. tostring(err))
        return false
    end
    
    -- Save to file
    local writeSuccess, writeErr = pcall(writefile, filePath, jsonData)
    
    if writeSuccess then
        print("[Config] Saved: '" .. configName .. "' successfully!")
        refreshConfigsList()
        return true
    else
        warn("[Config] Error: Failed to save config: " .. tostring(writeErr))
        return false
    end
end

-- Function to load configuration
local function loadConfig(configName)
    if not configName or configName == "" then
        warn("[Config] Error: Please select a config to load!")
        return false
    end
    
    local filePath = configsFolder .. "/" .. configName .. ".json"
    
    if not isfile(filePath) then
        warn("[Config] Error: Config '" .. configName .. "' doesn't exist!")
        return false
    end
    
    -- Read config file
    local success, fileContent = pcall(readfile, filePath)
    
    if not success then
        warn("[Config] Error: Failed to read config file!")
        return false
    end
    
    -- Parse JSON
    local configData
    local parseSuccess, parseErr = pcall(function()
        configData = HttpService:JSONDecode(fileContent)
    end)
    
    if not parseSuccess then
        warn("[Config] Error: Failed to parse config data: " .. tostring(parseErr))
        return false
    end
    
    -- Apply settings
    local loadedCount = 0
    if configData.Settings then
        for name, settingData in pairs(configData.Settings) do
            if settingData.Value ~= nil then
                local success = setSettingValue(name, settingData.Value)
                if success then
                    loadedCount = loadedCount + 1
                end
            end
        end
    end
    
    currentConfig = configName
    print("[Config] Loaded: '" .. configName .. "' successfully! (" .. loadedCount .. " settings applied)")
    
    return true
end

-- Function to delete configuration
local function deleteConfig(configName)
    if not configName or configName == "" then
        warn("[Config] Error: Please select a config to delete!")
        return false
    end
    
    local filePath = configsFolder .. "/" .. configName .. ".json"
    
    if not isfile(filePath) then
        warn("[Config] Error: Config '" .. configName .. "' doesn't exist!")
        return false
    end
    
    local deleteSuccess, deleteErr = pcall(delfile, filePath)
    
    if deleteSuccess then
        print("[Config] Deleted: '" .. configName .. "' successfully!")
        
        if currentConfig == configName then
            currentConfig = nil
        end
        
        refreshConfigsList()
        return true
    else
        warn("[Config] Error: Failed to delete config: " .. tostring(deleteErr))
        return false
    end
end

-- Function to auto-load config on startup
local function autoLoadConfig()
    if not autoLoadEnabled then return false end
    
    -- Check for auto-load config
    local autoLoadFile = configsFolder .. "/autoload.txt"
    
    if isfile(autoLoadFile) then
        local configName = readfile(autoLoadFile)
        if configName and configName ~= "" then
            return loadConfig(configName)
        end
    else
        -- Try to load first config if exists
        refreshConfigsList()
        if #configsList > 0 then
            return loadConfig(configsList[1])
        end
    end
    
    return false
end

-- Function to set auto-load config
local function setAutoLoadConfig(configName, enabled)
    autoLoadEnabled = enabled
    
    if enabled and configName then
        local autoLoadFile = configsFolder .. "/autoload.txt"
        writefile(autoLoadFile, configName)
        print("[Config] Auto-load enabled for: " .. configName)
    elseif not enabled then
        local autoLoadFile = configsFolder .. "/autoload.txt"
        if isfile(autoLoadFile) then
            delfile(autoLoadFile)
        end
        print("[Config] Auto-load disabled")
    end
end

-- Function to get all saved configs
local function getConfigs()
    refreshConfigsList()
    return configsList
end

-- Function to check if config exists
local function configExists(configName)
    local filePath = configsFolder .. "/" .. configName .. ".json"
    return isfile(filePath)
end

-- Function to export config as string (for sharing)
local function exportConfig(configName)
    if not configName or configName == "" then
        return nil
    end
    
    local filePath = configsFolder .. "/" .. configName .. ".json"
    
    if not isfile(filePath) then
        return nil
    end
    
    local success, content = pcall(readfile, filePath)
    
    if success then
        -- Encode for sharing
        local encoded = HttpService:JSONEncode({
            Name = configName,
            Data = content
        })
        return encoded
    end
    
    return nil
end

-- Function to import config from string
local function importConfig(encodedString, overwrite)
    local success, data = pcall(function()
        return HttpService:JSONDecode(encodedString)
    end)
    
    if not success or not data.Name or not data.Data then
        return false
    end
    
    local filePath = configsFolder .. "/" .. data.Name .. ".json"
    
    if isfile(filePath) and not overwrite then
        warn("[Config] Error: Config '" .. data.Name .. "' already exists!")
        return false
    end
    
    local writeSuccess = pcall(writefile, filePath, data.Data)
    
    if writeSuccess then
        print("[Config] Imported: '" .. data.Name .. "' successfully!")
        refreshConfigsList()
        return true
    end
    
    return false
end

-- Initialize config system
refreshConfigsList()
print("[Config] System initialized. Found " .. #configsList .. " config(s)")

-- Auto-load on startup
if isfile(configsFolder .. "/autoload.txt") then
    autoLoadEnabled = true
    autoLoadConfig()
end

-- Export the config system functions
return {
    -- Core Functions
    saveConfig = saveConfig,
    loadConfig = loadConfig,
    deleteConfig = deleteConfig,
    overwriteConfig = function(configName) return saveConfig(configName, true) end,
    
    -- Settings Management
    registerSetting = registerSetting,
    getSettingValue = getSettingValue,
    setSettingValue = setSettingValue,
    
    -- Auto-load Functions
    setAutoLoad = setAutoLoadConfig,
    autoLoadConfig = autoLoadConfig,
    isAutoLoadEnabled = function() return autoLoadEnabled end,
    
    -- Utility Functions
    getConfigs = getConfigs,
    configExists = configExists,
    refreshConfigs = refreshConfigsList,
    getCurrentConfig = function() return currentConfig end,
    
    -- Import/Export Functions
    exportConfig = exportConfig,
    importConfig = importConfig,
    
    -- Info
    getConfigCount = function() return #configsList end,
    getConfigsFolder = function() return configsFolder end
}
